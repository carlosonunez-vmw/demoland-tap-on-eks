# Demo: Organize your APIs with TAP

This demo highlights how developers can onboard APIs, internal or external,
into TAP with API Auto Registration, and how security can vet API posture
against enterprise standards with API Scoring.

- [RM/3KPs](#resounding-messages)
- [Setup Instructions: Internal APIs](#internal-api-demo)
- [Things To Point Out](#things-to-point-out)

## Resounding Messages

### API Discoverability

API Auto Registration allows your developers to easily catalog the APIs
that their applications consume, enhancing documentation, discoverability and
re-use.

#### Three Key Points

- API Auto Registration allows developers to catalog their APIs with zero
  additional work
- API Auto Registration is fully backed by OpenAPI; no special languages
  required.
- API Auto Registration exposes all of your APIs and their relationship in the
  API portal.

### Measure API posture with API Scoring

API Validation Scoring enables developers to see how their API specifications
stack up against industry best practices.

#### Three Key Points

- Security can see how secure an API is by its spec using the API security score
- Developers can see how well an API stacks up against OpenAPI best practices
  with the OpenAPI score
- Developers can also see how well their API is documented with the
  Documentation Score.

## Setting up the demo

### Prerequisites

- Harbor registry
- Tanzu CLI with the `apps` plugin installed
- `apis.apps.tanzu.vmware.com` TAP package installed
- Tanzu SQL for PostgreSQL

> The stack provided in this repository sets all of this up for you.

### Instructions

#### Internal API Example

This uses a Spring Boot API generated by a built-in Accelerator to demonstrate
how Developers can create APIs that will automatically be catalogued right
from an accelerator.

#### Provisioning

1. Provision a TAP cluster, if you don't already have one.

   [Click here](../../../README.md) to learn how to do that using the stack
   provided in this repo. This stack will also provision a Harbor registry for
   you at `harbor.$DOMAIN_NAME`.

2. Log into Harbor and create a public project called `tap-app-images`.

3. Log into the TAP GUI. If you used this stack to provision TAP,
   it will be accessible from `tap-gui.${dns_root_zone_from_config}`.

4. Click on the "Create" button. Choose the "Tanzu Java Restful Web App"
   accelerator with these options:
   - **Expose API Endpoint**: checked
   - **Use Spring Boot 3.0?**: checked
   - **Java Version**: Java 17

5. Click "Next", then download the ZIP file into the folder of your choice and
   extract.

> âœ… If you want to skip using the GUI, an example API generated from this
> accelerator is included in this directory under `example-api`.

6. Open a terminal.

7. Open `config/service-operator/postgres-instance.yaml` and remove the
   following:

   ```yaml
   cpu: whatever
   memory: whatever
   ```

8. Change the references to `storageClass` to `gp2` (or whatever storage
   class you'd like to use).

9. Create the testing pipeline and database.

   ```sh
   kubectl create -n service-instances
   find ${DIRECTORY}/config -name '*.yaml' -not -name 'workload.yaml' \
        -not 'postgres-resource-claim-policy.yaml' \
        -exec kubectl apply -n ${DEV_NAMESPACE} -f {} \;
   kubectl apply -f "${DIRECTORY}/config/service-operator/postgres-resource-claim-policy.yaml"
   ```

10. At this time of writing, `example-api` ships with five critical CVEs.
   Run `kubectl edit scanpolicy scan-policy -n apps` and modify
   `ignoreCves` to the following list:

   ```sh
       ignoreCves := [
      "CVE-2015-0244",
      "CVE-2015-3166",
      "CVE-2018-1115",
      "CVE-2019-10211",
      "GHSA-36p3-wjmg-h94x"
    ]
   ```

11. Create the workload:

    ```sh
    tanzu apps workload apply \
      --file "${DIRECTORY}/config/workload.yaml" \
      --namespace apps \
      --source-image harbor.${root_zone_in_config}/tap-app-images/example-api \
      --local-path "${DIRECTORY}/example-api" \
      --yes \
      --tail
    ```

## Things To Point Out

### API Portal

### Whitelisting CVEs with Custom Scan Policies

**Audience**: Security

- Use the Security screen within the TAP GUI to demonstrate how this is a great
  example of a "bad app"
- Use the Security screen within the TAP GUI to demonstrate how a custom
  scan policy was created in this namespace to ignore CVEs that we're
  willing to live with.

### Databases on Demand with Tanzu SQL

**Audience**: Developers, Platform Eng, DBAs, Eng. Mgmt

- Open `config/service-operator/postgres-instance.yaml` in an IDE
  to demonstrate how easily developers can request databases within TAP
- Open `config/workload.yaml` and scroll down to `serviceClaims` to
  demonstrate how easily developers can bind databases to their app via
  Service Bindings
    - No more managing database secrets; Service Bindings automates
      everything
    - Service Bindings works with Buildpacks provided by the Tanzu
      Build Service to write database information in a way that
      your app will automatically consume.

## Troubleshooting

### I can't find the API in the API portal

- Check that the `apidescriptor` isn't in a failed state: `kubectl get -n
  [DEV_NS] apidescriptor`
- If it is, you'll need to re-apply the `APIDescriptor`'s YAML since it doesn't
  seem to automatically reconcile. `kubectl get -n [DEV_NS] apidescriptor
  [FAILING_DESC] -o yaml > /tmp/patch.yaml && kubectl apply -n [DEV_NS] -f
  /tmp/patch.yaml`
